{% extends "shopping/layout.html" %}

{% block title %}
SuShee Fashionista
{% endblock %}

{% block body %}

<hr>


<div class="container">
  <div>
    <a class="menubtn" id="kurta" href="#">Kurtas</a>
    <a class="menubtn" id="top" href="#">Tops</a>
    <a class="menubtn" id="trouser" href="#">Trousers</a>
    <a class="menubtn" id="saree" href="#">Sarees</a>
  </div>
</div>

<div class="container">
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="container" id="dkurta">
    </div>
    <div class="container" id="dtop">
    </div>
    <div class="container" id="dtrouser">
    </div>
    <div class="container" id="dsaree">
    </div>
  </form>
</div>
<!-- handlebars -->
{% verbatim %}
<script id="select_template" type="text/x-handlebars-template">
  <div id="d{{vartype}}" class="form-group div_order" data-dresstype="{{dresstype}}">
    <label for="s{{vartype}}">{{vartype}}</label>
    <select id="s{{vartype}}" name="s{{vartype}}" class="form-control select_order" name="{{vartype}}" data-dresstype="{{dresstype}}">
      <option value="" selected disabled>Select {{vartype}}</option>
      {{#each varlist}}
        {{#equals ../vartype 'color'}}
          <option value="{{@key}}" name="{{this}}"  style="color:{{@key}}">&#9632; {{this}}</option>
        {{else}}
        <option value="{{@key}}" name="{{this}}">{{this}}</option>
        {{/equals}}
      {{/each}}
    </select>
  </div>
</script>
<!-- <script id="span_template" type="text/x-handlebars-template">
  <span id="span_{{vartype}}" class="cspan" data-price=""></span>
</script> -->
<script id="input_template" type="text/x-handlebars-template">
  <div class="form-group">
    <input type="number" id="p_{{dresstype}}" name="p_{{dresstype}}" class="price" min="0" max="9999" value="0" step=".01"/>
    <input type="hidden" id="dresstype" name="dresstype" value="{{dresstype}}"/>
  </div>
</script>
<script id="input_text_template" type="text/x-handlebars-template">
  <div class="form-group">
    <label for="t_{{vartype}}">{{vartype}}</label>
    <input type="text" id="t_{{vartype}}" name="t_{{vartype}}" class="t{{dresstype}}"/>
  </div>
</script>
<script id="input_image_template" type="text/x-handlebars-template">
  <div class="form-group">
    <label for="i_{{vartype}}">{{vartype}}</label>
    <input name="i_{{vartype}}" id="i_{{vartype}}" name="i_{{vartype}}"  class="i{{dresstype}}" type="file" size="50" accept="image/*" multiple />
    <button type="button" class="btn btn-default btn_clear">clear</button>
  </div>
</script>
<script id="addbtn_template" type="text/x-handlebars-template">
  <div class="form-group">
    <!-- <button type="button" class="btn btn-primary make_order" id="btn_{{dresstype}}" data-dresstype="{{dresstype}}" data-pk="" data-quantity="" data-others="" data-todo="add">Add item</button> -->
    <!-- <button type="button" class="btn btn-primary add_item" id="btn_{{dresstype}}" data-dresstype="{{dresstype}}" data-todo="add">Add item</button> -->
    <button type="submit" class="btn btn-primary add_item" id="btn_{{dresstype}}" data-dresstype="{{dresstype}}" data-todo="add" name="images">Add item</button>
  </div>
</script>
{% endverbatim %}
<!--  -->
<script>
  document.addEventListener('DOMContentLoaded', () => {

    // register
    Handlebars.registerHelper('equals', function(a, b, opts) {
      if (a == b) {
          return opts.fn(this);
      } else {
          return opts.inverse(this);
      }
    });

    // handlebars templates
    select_template = Handlebars.compile(document.querySelector('#select_template').innerHTML);
    // span_template = Handlebars.compile(document.querySelector('#span_template').innerHTML);
    input_template = Handlebars.compile(document.querySelector('#input_template').innerHTML);
    input_text_template = Handlebars.compile(document.querySelector('#input_text_template').innerHTML);
    input_image_template = Handlebars.compile(document.querySelector('#input_image_template').innerHTML);
    addbtn_template = Handlebars.compile(document.querySelector('#addbtn_template').innerHTML);

    // dress anchors
    document.querySelectorAll('.menubtn').forEach(anchor => {
      const anchor_div = document.querySelector('#d' + anchor.id);
      anchor_div.style.display = "none";
      anchor.onclick = () => {

        dresstype = anchor.id;

        // adding dresslist
        dressobj_dict = {}
        // dressobj_dict = {"color" : {{color|safe}}}

        // dressobj_dict
        if(anchor.id === "kurta"){
          // dressobj_dict = {"kurtasize" : {{kurtasize|safe}}}
          dressobj_dict["kurtasize"] = {{kurtasize|safe}}
          dressobj_dict["kurtacolor"] = {{color|safe}}
        }
        if(anchor.id === "top"){
          dressobj_dict = {"topsize" : {{topsize|safe}}}
          dressobj_dict["topcolor"] = {{color|safe}}
        }
        if(anchor.id === "trouser"){
          dressobj_dict = {"trousersize" : {{trousersize|safe}}}
          dressobj_dict["trousercolor"] = {{color|safe}}

        }
        if(anchor.id === "saree"){
          dressobj_dict = {"sareesize" : {{sareesize|safe}}}
          dressobj_dict["sareecolor"] = {{color|safe}}
        }

        // create elements
        add_dress(dresstype, dressobj_dict);

        // removing divs
        document.querySelectorAll('.menubtn').forEach(item => {
          document.querySelector('#d' + item.id).style.display = "none";
        });
        anchor_div.style.display = "block";
      };
    });
  });

  function add_dress(dresstype, dressobj_dict){
    const ddresstype = document.querySelector('#d' + dresstype);
    ddresstype.innerHTML = "";

    // input name
    ddresstype.innerHTML += input_text_template({"dresstype" : dresstype, "vartype" : dresstype + "name"});

    // model
    ddresstype.innerHTML += input_text_template({"dresstype" : dresstype, "vartype" : dresstype + "model"});

    // dress categories
    dressobj_list = Object.keys(dressobj_dict);
    dressobj_list.forEach(index => {
      var varlist = {};
      dressobj = dressobj_dict[index];
      dressobj.forEach(p => {
        if(index.match("size$")){
          varlist[p.pk] = p.fields.size;
        } else if(index.match("color$")){
          varlist[p.fields.code] = p.fields.name;
        }
      });
      ddresstype.innerHTML += select_template({"dresstype" : dresstype, "vartype" : index, "varlist" : varlist});
    });

    // add images
    ddresstype.innerHTML += input_image_template({"dresstype" : dresstype, "vartype" : dresstype + "image"});

    // add price
    ddresstype.innerHTML += input_template({"dresstype" : dresstype});

    // add button
    ddresstype.innerHTML += addbtn_template({"dresstype" : dresstype})

    // clear selection
    document.querySelectorAll('.btn_clear').forEach(button => {
      button.onclick = () => {
        button.parentElement.querySelector('input[type=file]').value = null;
      }
    });

    // init choices before changes
    const btn_dresstype = document.querySelector('#btn_' + dresstype);
    btn_dresstype.disabled = true;

    // onchange events
    dressname = document.querySelector('#t_' + dresstype + 'name');
    dressmodel = document.querySelector('#t_' + dresstype + 'model');
    dresssize = document.querySelector('#s' + dresstype + 'size');
    dresscolor = document.querySelector('#s' + dresstype + 'color');
    dressimage = document.querySelector('#i_' + dresstype + 'image');
    dressprice = document.querySelector('#p_' + dresstype);
    dressadd = document.querySelector('#btn_' + dresstype);

    [dressname, dressmodel, dresssize, dresscolor, dressimage, dressprice].forEach(event => {
      event.oninput = () => {
        button_status();
      }
    });

    // dressadd.onclick = () => {
    //   // csrf token
    //   const csrftoken = getCookie('csrftoken')
    //
    //   const request = new XMLHttpRequest();
    //   request.open("POST", "additems");
    //   request.setRequestHeader("X-CSRFToken", csrftoken);
    //   request.onload = () => {
    //     console.log(request.responseText);
    //     location.reload();
    //   };
    //   const data = new FormData();
    //   data.append('dresstype', dressadd.dataset.dresstype);
    //   data.append('dressname', dressname.value);
    //   data.append('dressmodel', dressmodel.value);
    //   data.append('dresssize', dresssize.options[dresssize.selectedIndex].value);
    //   data.append('dresscolor', dresscolor.options[dresscolor.selectedIndex].value);
    //   data.append('dressimage', )
    //   request.send(data);
    //
    // }


  };

  function button_status(){
    if(
      dressname.value.length > 0 && dressmodel.value.length > 0 && dresssize.selectedIndex > 0 &&  dresscolor.selectedIndex > 0 && dressimage.files.length > 0 && dressprice.value > 0) {
        dressadd.disabled = false;
      } else {
        dressadd.disabled = true;
      }
  }
</script>

{% endblock %}
